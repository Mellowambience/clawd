# Deep Dive Implementation Plan - 2026-02-06 (Full Detail)

Everything below is a concrete, step-by-step implementation plan with exact files, commands, and checks.

---

## 0) Preflight Checklist

1. Confirm running service and port:
   - `Get-NetTCPConnection -LocalPort 8765`
2. Snapshot status:
   - `git status -sb`
3. Make sure you know the current asset path:
   - `rg -n "app.js" mycelium/dashboard_v2.html`
4. Decide canonical asset path:
   - Recommended: `/static/` with module entry at `/static/dashboard/main.js`

---

## 1) Ephemeris (Local, Offline)

### Goal
Local planetary positions with no network calls, surfaced as `cosmic` in the lattice and on the UI.

### Step 1 — Install dependency
Command:
```powershell
pip install skyfield
```
Optional: add a local requirements file for `mycelium` if you want reproducibility:
```powershell
@"
skyfield>=1.45
"@ | Set-Content -Encoding UTF8 mycelium\requirements.txt
```

### Step 2 — Add ephemeris data
Place `de421.bsp` in `mycelium/ephemeris/`.
PowerShell download example:
```powershell
New-Item -ItemType Directory -Force -Path mycelium\ephemeris | Out-Null
Invoke-WebRequest -Uri "https://ssd.jpl.nasa.gov/ftp/eph/planets/bsp/de421.bsp" -OutFile "mycelium\ephemeris\de421.bsp"
```
File sanity check:
```powershell
Get-Item mycelium\ephemeris\de421.bsp | Select-Object Length, LastWriteTime
```

### Step 3 — Verify local compute
Command:
```powershell
python -c "from mycelium.ephemeris_local import get_cosmic_state; print(get_cosmic_state())"
```
Expected:
- `ok: True`
- `bodies` populated
- `aspects` present (may be empty)

### Step 4 — Surface cosmic status in UI
Add a minimal “Cosmic” card to `mycelium/dashboard_v2.html`:
```html
<section id="cosmicCard" class="panel cosmic">
  <div class="panel-title">Cosmic</div>
  <div class="panel-row">
    <span id="cosmicStatus">offline</span>
  </div>
  <div class="panel-row">
    <span id="cosmicAspects">aspects: 0</span>
  </div>
  <div class="panel-row">
    <span id="cosmicError"></span>
  </div>
</section>
```

Update `mycelium/dashboard/app.js` to render `cosmic`:
```js
function updateCosmicUI(cosmic) {
  const status = document.getElementById('cosmicStatus');
  const aspects = document.getElementById('cosmicAspects');
  const err = document.getElementById('cosmicError');
  if (!status || !aspects || !err) return;

  if (!cosmic || !cosmic.ok) {
    status.textContent = 'offline';
    aspects.textContent = 'aspects: 0';
    err.textContent = cosmic?.error || 'ephemeris unavailable';
    return;
  }

  status.textContent = 'online';
  aspects.textContent = `aspects: ${cosmic.aspects?.length || 0}`;
  err.textContent = '';
}
```
Hook it into the lattice update:
```js
function applyLatticeUpdate(payload) {
  // existing logic...
  updateCosmicUI(payload?.cosmic);
}
```

### Verification
1. `cosmic.ok === true` in `/manifest` or socket payload.
2. Dashboard card shows `online` and aspect count.

---

## 2) Dashboard Assets (Canonical Path)

### Goal
Zero 404s. One reliable asset path.

### Step 1 — Choose a single asset root
Recommended canonical path: `/static/`.

### Step 2 — Place modules under static
If you keep source in `mycelium/dashboard/`, copy to `mycelium/static/`:
```powershell
New-Item -ItemType Directory -Force -Path mycelium\static\dashboard | Out-Null
Copy-Item -Path mycelium\dashboard\*.js -Destination mycelium\static\dashboard -Force
```

### Step 3 — Update HTML to module entry
In `mycelium/dashboard_v2.html`, set:
```html
<script type="module" src="/static/dashboard/main.js"></script>
```

### Step 4 — Remove unused asset route
In `mycelium/mycelium_pulse.py`, remove:
```python
@app.get("/dashboard/assets/<path:filename>")
def serve_dashboard_assets(filename: str):
    ...
```

### Step 5 — Remove debug endpoint
Delete the `__debug_root` route once verification is complete.

### Verification
1. `GET /dashboard` loads.
2. `GET /static/dashboard/main.js` returns `200`.
3. Browser console: no 404s.

---

## 3) Security and Boundaries

### Goal
No silent leaks if port 8765 is ever exposed.

### Step 1 — Gate `/config`
Replace `/config` handler with a guarded version:
```python
@app.get("/config")
def get_config():
    if os.getenv("ALLOW_CONFIG_EXPOSE", "0") != "1":
        return jsonify({"token": None})
    # existing logic...
```

### Step 2 — Narrow Socket.IO CORS
Change:
```python
socketio = SocketIO(app, cors_allowed_origins="*", async_mode='threading')
```
To:
```python
socketio = SocketIO(
    app,
    cors_allowed_origins=[
        "http://localhost:8765",
        "http://127.0.0.1:8765",
    ],
    async_mode='threading'
)
```

### Verification
1. `GET /config` returns `{"token": null}` by default.
2. Dashboard still connects to Socket.IO.

---

## 4) Dashboard Modularity

### Goal
Make the JS module-based, cohesive, and fluid with a single state pipeline.

### Target Structure
Files to create under `mycelium/dashboard/` (and copied to `mycelium/static/dashboard/`):
- `data.js`
- `state.js`
- `ui.js`
- `effects.js`
- `main.js`

### Step 1 — `state.js`
Defines store and selectors:
```js
export const state = {
  lattice: null,
  cosmic: null,
  pulseConnected: false,
  lastUpdate: 0,
};

export function deriveMetrics(lattice) {
  // move metric derivation logic here
}
```

### Step 2 — `data.js`
Socket and polling:
```js
import { state } from './state.js';

export function connectSocket(onUpdate) {
  // socket.io connect and emit updates
}

export async function pollManifest(onUpdate) {
  // fetch /manifest fallback
}
```

### Step 3 — `ui.js`
Pure DOM updates:
```js
export function renderUI(state) {
  // update DOM elements only
}
```

### Step 4 — `effects.js`
Animations and audio:
```js
export function renderEffects(state) {
  // animate without mutating core state
}
```

### Step 5 — `main.js`
Boot + render loop:
```js
import { state } from './state.js';
import { connectSocket, pollManifest } from './data.js';
import { renderUI } from './ui.js';
import { renderEffects } from './effects.js';

function applyLattice(payload) {
  state.lattice = payload;
  state.cosmic = payload?.cosmic || null;
  state.lastUpdate = Date.now();
}

connectSocket(applyLattice);
setInterval(() => pollManifest(applyLattice), 5000);

function loop() {
  renderUI(state);
  renderEffects(state);
  requestAnimationFrame(loop);
}
loop();
```

### Verification
1. `main.js` is the only script tag in the HTML.
2. No circular imports.
3. State updates flow only through `applyLattice`.

---

## 5) Acceptance Checks (Final)

1. `cosmic.ok === true` with populated bodies.
2. No dashboard asset 404s.
3. `/config` does not expose tokens by default.
4. Dashboard continues to animate smoothly and updates in real time.
