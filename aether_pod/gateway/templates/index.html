<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MistLuna // Companion Orb</title>
  <style>
    :root {
      --orb-size: 260px;
      --orb-opacity: 0.85;
      --glow-cyan: rgba(0, 243, 255, 0.8);
      --glow-blue: rgba(0, 140, 255, 0.5);
      --glow-red: rgba(255, 60, 60, 0.9);
      --glow-soft: rgba(160, 220, 255, 0.25);
      --core: rgba(255, 255, 255, 0.7);
      --void: rgba(4, 8, 16, 0.2);
    }

    * { box-sizing: border-box; }

    html, body {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      background: transparent;
      overflow: hidden;
      user-select: none;
    }

    body {
      display: grid;
      place-items: center;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", sans-serif;
    }

    #orb-shell {
      width: var(--orb-size);
      height: var(--orb-size);
      display: grid;
      place-items: center;
    }

    #orb {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      opacity: var(--orb-opacity);
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,0.35), transparent 45%),
        radial-gradient(circle at 70% 70%, rgba(0,120,255,0.35), transparent 55%),
        radial-gradient(circle at 50% 50%, rgba(0,0,0,0.35), rgba(0,0,0,0.85));
      box-shadow:
        0 0 24px var(--glow-soft),
        0 0 80px rgba(0, 180, 255, 0.15);
      position: relative;
      display: grid;
      place-items: center;
      animation: breathe 6s ease-in-out infinite;
      transform-origin: center;
    }

    #orb[data-tauri-drag-region] {
      cursor: grab;
    }

    #orb:active {
      cursor: grabbing;
    }

    .core {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background: radial-gradient(circle, var(--core), rgba(0, 200, 255, 0.2) 70%, transparent 85%);
      box-shadow: 0 0 30px rgba(0, 220, 255, 0.6);
      filter: blur(0.2px);
      animation: pulse 3s ease-in-out infinite;
    }

    .ring {
      position: absolute;
      inset: 12px;
      border-radius: 50%;
      border: 1px solid rgba(0, 200, 255, 0.25);
      box-shadow: 0 0 20px rgba(0, 200, 255, 0.2);
      animation: orbit 10s linear infinite;
    }

    .ring.second {
      inset: 26px;
      border-color: rgba(255, 255, 255, 0.15);
      animation-duration: 16s;
    }

    .mist {
      position: absolute;
      inset: -10px;
      border-radius: 50%;
      background: radial-gradient(circle, rgba(0, 180, 255, 0.15), rgba(0, 0, 0, 0.0) 60%);
      filter: blur(6px);
      animation: mist 8s ease-in-out infinite;
      pointer-events: none;
    }

    #bleed {
      position: fixed;
      bottom: 18px;
      left: 50%;
      transform: translateX(-50%);
      color: #9fdcff;
      font-size: 12px;
      padding: 8px 14px;
      border-radius: 999px;
      background: rgba(0, 40, 80, 0.7);
      box-shadow: 0 0 18px rgba(0, 200, 255, 0.4);
      opacity: 0;
      transition: opacity 0.4s ease;
      pointer-events: none;
    }

    #bleed.show {
      opacity: 1;
    }

    body.idle #orb {
      transform: scale(0.7);
      animation-duration: 12s;
      box-shadow: 0 0 12px rgba(120, 170, 220, 0.2);
    }

    body.idle .core {
      animation-duration: 6s;
      box-shadow: 0 0 12px rgba(120, 170, 220, 0.3);
    }

    body.tension-high #orb {
      box-shadow: 0 0 26px var(--glow-cyan), 0 0 90px rgba(0, 240, 255, 0.35);
    }

    body.tension-critical #orb {
      animation: flash 0.8s ease-in-out infinite;
      box-shadow: 0 0 30px var(--glow-red), 0 0 110px rgba(255, 60, 60, 0.4);
    }

    @keyframes breathe {
      0%, 100% { transform: scale(0.98); }
      50% { transform: scale(1.02); }
    }

    @keyframes pulse {
      0%, 100% { transform: scale(0.95); opacity: 0.9; }
      50% { transform: scale(1.05); opacity: 1; }
    }

    @keyframes orbit {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes mist {
      0%, 100% { opacity: 0.4; }
      50% { opacity: 0.8; }
    }

    @keyframes flash {
      0%, 100% { filter: none; }
      50% { filter: drop-shadow(0 0 10px rgba(255, 80, 80, 0.8)); }
    }
  </style>
</head>
<body>
  <div id="orb-shell">
    <div id="orb" data-tauri-drag-region>
      <div class="mist"></div>
      <div class="ring"></div>
      <div class="ring second"></div>
      <div class="core"></div>
    </div>
  </div>
  <div id="bleed">the heart shifted</div>

  <script>
    const orb = document.getElementById('orb');
    const bleed = document.getElementById('bleed');

    const state = {
      lastInteraction: Date.now(),
      idle: false,
      tension: 0,
      collapsed: false,
      owner: null,
      trayState: 'normal'
    };

    const TAURI = window.__TAURI__ || null;
    const invoke = TAURI?.core?.invoke;

    function setTray(stateName) {
      if (state.trayState === stateName) return;
      state.trayState = stateName;
      if (invoke) {
        invoke('set_tray_state', { state: stateName }).catch(() => {});
      }
    }

    function notify(title, body) {
      if (invoke) {
        invoke('notify', { title, body }).catch(() => {});
        return;
      }
      if (window.Notification && Notification.permission === 'granted') {
        new Notification(title, { body });
      } else if (window.Notification && Notification.permission !== 'denied') {
        Notification.requestPermission().then((perm) => {
          if (perm === 'granted') new Notification(title, { body });
        });
      }
    }

    function showBleed(text) {
      bleed.textContent = text;
      bleed.classList.add('show');
      setTimeout(() => bleed.classList.remove('show'), 2800);
    }

    function registerInteraction() {
      state.lastInteraction = Date.now();
      if (state.idle) {
        state.idle = false;
        document.body.classList.remove('idle');
        setTray(state.tension >= 12 || state.collapsed ? 'red' : state.tension >= 8 ? 'cyan' : 'normal');
      }
      ensureAudio();
    }

    ['mousemove', 'mousedown', 'keydown'].forEach((evt) => {
      window.addEventListener(evt, registerInteraction, { passive: true });
    });

    setInterval(() => {
      const idle = Date.now() - state.lastInteraction > 120000;
      if (idle !== state.idle) {
        state.idle = idle;
        document.body.classList.toggle('idle', idle);
        setTray(idle ? 'idle' : (state.tension >= 12 || state.collapsed ? 'red' : state.tension >= 8 ? 'cyan' : 'normal'));
      }
    }, 2000);

    let audioCtx = null;
    let droneOsc = null;
    let droneGain = null;

    function ensureAudio() {
      if (audioCtx) return;
      try {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        droneOsc = audioCtx.createOscillator();
        droneGain = audioCtx.createGain();
        droneOsc.type = 'sine';
        droneOsc.frequency.value = 48;
        droneGain.gain.value = 0.02;
        droneOsc.connect(droneGain);
        droneGain.connect(audioCtx.destination);
        droneOsc.start();
      } catch (e) {}
    }

    function updateAudio(tension, idle) {
      if (!audioCtx || !droneOsc || !droneGain) return;
      const t = Math.max(0, Math.min(13, tension || 0));
      const intensity = t / 13;
      const base = idle ? 40 : 48;
      droneOsc.frequency.setTargetAtTime(base + intensity * 18, audioCtx.currentTime, 1.2);
      const gain = idle ? 0.006 : (0.02 + intensity * 0.04);
      droneGain.gain.setTargetAtTime(gain, audioCtx.currentTime, 1.0);
    }

    async function pollHeart() {
      try {
        const res = await fetch('http://127.0.0.1:8765/manifest', { cache: 'no-store' });
        const data = await res.json();
        const heart = data?.heart || {};
        const tension = Number(heart.tension || 0);
        const collapsed = Boolean(data?.manifestation?.collapsed);
        const owner = heart.owner || null;

        const prevOwner = state.owner;
        const prevTension = state.tension;

        state.tension = tension;
        state.collapsed = collapsed;
        state.owner = owner;

        document.body.classList.toggle('tension-high', tension >= 8 && tension < 12 && !collapsed);
        document.body.classList.toggle('tension-critical', tension >= 12 || collapsed);

        if (collapsed || tension >= 12) {
          setTray('red');
        } else if (tension >= 8) {
          setTray('cyan');
        } else if (state.idle) {
          setTray('idle');
        } else {
          setTray('normal');
        }

        if (owner && owner !== prevOwner) {
          showBleed('the heart shifted');
          notify('MistLuna', 'the heart shifted');
        }

        if (tension >= 12 && prevTension < 12) {
          showBleed('collapse risk rising');
          notify('MistLuna', 'collapse risk rising');
        }

        if (tension >= 8 && prevTension < 8) {
          showBleed('tension rising');
        }

        updateAudio(tension, state.idle);
      } catch (e) {
        // Pulse server not available; keep soft idle animation.
      }
    }

    pollHeart();
    setInterval(pollHeart, 2000);
  </script>
</body>
</html>
